<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title id="pageTitle">SumOS RealTime Terminal! — (robotName)</title>
  <style>
    :root{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,'Roboto Mono','Courier New',monospace}
    html,body{margin:0;height:100%;overflow:hidden;background:#000814;color:#d1ffd6}
    body{display:flex;flex-direction:column}
    header{padding:12px 16px;background:#001122;display:flex;align-items:center;gap:12px;flex-shrink:0}
    header .brand{display:flex;flex-direction:column}
    header h1{font-size:16px;margin:0;color:#7fff7f}
    header p{margin:0;font-size:12px;color:#6fb3a3}
    main{flex:1;display:flex;gap:12px;padding:12px;overflow:hidden}
    .terminal{flex:1;display:flex;flex-direction:column;background:linear-gradient(180deg,#001018,#00202a);
      border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    .chat{flex:1;overflow-y:auto;padding:12px;border-radius:6px;background:#000;
      font-family:ui-monospace,monospace;font-size:13px;line-height:1.5;color:#bfffbf}
    .bubble{display:inline-block;padding:6px 10px;border-radius:8px;margin:6px 0;max-width:85%}
    .robot{background:rgba(12,40,30,0.9);color:#bfffbf;border-bottom-left-radius:2px}
    .you{background:#063a35;color:#eafff0;border-bottom-right-radius:2px;align-self:flex-end}
    .meta{width:260px;background:#001a1a;border-radius:8px;padding:12px;font-size:13px;flex-shrink:0;overflow:auto}
    .meta .row{margin-bottom:8px}
    .small{font-size:12px;color:#9fb3c4}
    .controls{display:flex;gap:8px;margin-top:8px}
    input[type=text]{flex:1;padding:10px;border-radius:6px;border:1px solid #023;background:#00191a;color:inherit}
    button{padding:10px 12px;border-radius:6px;border:none;background:#04d29f;color:#012;cursor:pointer}
    .clearBtn{background:#ff7070;color:#000;font-weight:bold}
    footer{padding:8px 12px;font-size:12px;color:#9fb3c4;background:#00111a;flex-shrink:0}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#073b35;color:#dfffe8}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);
      display:flex;align-items:center;justify-content:center;z-index:40}
    .loginBox{width:420px;max-width:92%;border-radius:8px;padding:18px;background:#00110b;
      border:1px solid #033;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
    .loginTitle{color:#3aff3a;font-size:18px;margin:0 0 8px 0}
    .prompt{color:#9fffb0;background:#02130d;padding:10px;border-radius:6px;font-size:13px}
    .loginRow{display:flex;gap:8px;margin-top:12px}
    .ghost{background:transparent;border:1px dashed #0a5;padding:8px 10px;border-radius:6px;color:#9fffb0}
    .hint{font-size:12px;color:#6fb3a3;margin-top:8px}
    .blink{border-left:2px solid #0f0;padding-left:6px;animation:blink 1s steps(1) infinite}
    @keyframes blink{50%{border-color:transparent}}
    .control-links{margin-top:10px;display:flex;gap:8px}
    .link{color:#80ff80;cursor:pointer;text-decoration:underline;font-size:13px}
    .disconnect{margin-top:10px;padding:8px;border-radius:6px;background:#220a0a;color:#ffdede;border:none;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="badge">SumOS</div>
    <div class="brand">
      <h1 id="title">SumOS RealTime Terminal! — (robotName)</h1>
      <p class="muted">Realtime terminal for your robot — chat-style live feed</p>
    </div>
  </header>

  <main>
    <section class="terminal">
      <div class="chat" id="chat">Connecting...</div>
      <div class="controls">
        <input type="text" id="cmdInput" placeholder="Taip command (contoh: fl=30)" autocomplete="off">
        <button id="sendBtn">EXECUTE</button>
        <button id="clearBtn" class="clearBtn">CLEAR CHAT</button>
      </div>
    </section>

    <aside class="meta">
      <div class="row"><strong>Robot ID</strong></div>
      <div class="row small" id="robotId">-</div>
      <div class="row"><strong>Robot Name</strong></div>
      <div class="row small" id="robotName">-</div>
      <div class="row"><strong>Last command</strong></div>
      <div class="row small" id="lastCommand">-</div>
      <div class="row"><button id="disconnectBtn" class="disconnect" style="display:none">Disconnect</button></div>
      <div style="margin-top:8px" class="small">Tip: buka app dari Telegram supaya auto-detect ID.</div>
    </aside>
  </main>

  <footer>Connected • Ready</footer>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <div id="overlay" class="overlay" style="display:none">
    <div class="loginBox">
      <div class="loginTitle">TERMINAL LOGIN</div>
      <div class="prompt">ENTER TELEGRAM ID TO CONNECT <span class="blink">█</span></div>
      <div class="loginRow">
        <input id="manualId" class="ghost" placeholder="Telegram ID (nombor sahaja)" inputmode="numeric">
        <button id="manualConnect" class="ghost">CONNECT</button>
      </div>
      <div class="hint">Atau buka terus dari Telegram untuk auto-log-in.</div>
      <div class="control-links"><div id="clearLocal" class="link">Clear saved ID</div></div>
    </div>
  </div>

  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAFaOLWSUuGO1J_Y1DdCOK9IKVGxJAld8M",
      authDomain: "sumos-ai.firebaseapp.com",
      databaseURL: "https://sumos-ai-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sumos-ai",
      storageBucket: "sumos-ai.firebasestorage.app",
      messagingSenderId: "587439292501",
      appId: "1:587439292501:web:cb982fcf78e9ea442194dc",
      measurementId: "G-EK9X0CC8Y3"
    };

    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();

    let chatEl = document.getElementById('chat');
    let cmdInput = document.getElementById('cmdInput');
    let sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const robotIdEl = document.getElementById('robotId');
    const robotNameEl = document.getElementById('robotName');
    const lastCmdEl = document.getElementById('lastCommand');
    const titleEl = document.getElementById('title');
    const overlay = document.getElementById('overlay');
    const manualId = document.getElementById('manualId');
    const manualConnect = document.getElementById('manualConnect');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const clearLocal = document.getElementById('clearLocal');
    const pageTitle = document.getElementById('pageTitle'); // [ADD]

    function appendRobot(text){
      const div = document.createElement('div');
      div.className = 'bubble robot';
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function appendYou(text){
      const div = document.createElement('div');
      div.className = 'bubble you';
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    clearBtn.addEventListener('click', ()=>{ chatEl.innerHTML=''; appendRobot('[system] Chat cleared.'); });

    let telegramId=null, baseRef=null;

    function showOverlay(){overlay.style.display='flex';manualId.focus();}
    function hideOverlay(){overlay.style.display='none';}
    function validateId(id){return /^[0-9]{5,20}$/.test(id);}

    function setConnectedId(id){
      if(telegramId===id) return; // cegah reconnect sama
      telegramId=id;
      localStorage.setItem('sumos_telegram_id',id);
      robotIdEl.textContent=id;
      disconnectBtn.style.display='inline-block';
      hideOverlay();
      initListeners();
    }

    function clearConnection(){
      telegramId=null;
      robotIdEl.textContent='-';
      lastCmdEl.textContent='-';
      robotNameEl.textContent='-';
      disconnectBtn.style.display='none';
      localStorage.removeItem('sumos_telegram_id');
      if(baseRef) baseRef.off();
      chatEl.innerHTML='Disconnected.';
      showOverlay();
    }

    try{
      if(window.Telegram && Telegram.WebApp?.initDataUnsafe?.user?.id){
        const t=String(Telegram.WebApp.initDataUnsafe.user.id);
        console.log('Detected Telegram ID:',t);
        localStorage.setItem('sumos_telegram_id',t);
        setConnectedId(t);
      }else{
        const saved=localStorage.getItem('sumos_telegram_id');
        if(saved&&validateId(saved)){console.log('Loaded saved ID:',saved);setConnectedId(saved);}
        else showOverlay();
      }
    }catch(e){
      console.warn('Telegram detection failed',e);
      const saved=localStorage.getItem('sumos_telegram_id');
      if(saved&&validateId(saved)) setConnectedId(saved);
      else showOverlay();
    }

    manualConnect.addEventListener('click',()=>{
      const v=manualId.value.trim();
      if(!validateId(v)){alert('Masukkan ID sah.');return;}
      setConnectedId(v);
    });
    clearLocal.addEventListener('click',()=>{localStorage.removeItem('sumos_telegram_id');alert('Saved ID cleared');});
    disconnectBtn.addEventListener('click',()=>{if(confirm('Disconnect?'))clearConnection();});

    function initListeners(){
      if(!telegramId) return;
      if(baseRef) baseRef.off();
      chatEl.innerHTML='';
      appendRobot('Connected as Telegram ID: '+telegramId);
      baseRef=db.ref(telegramId);

      // [ADD] Auto update robotName ke title & header
      baseRef.child('robotName').on('value',s=>{
        const v=s.val();
        robotNameEl.textContent=v??'-';
        if(v){
          titleEl.textContent=`SumOS RealTime Terminal! — ${v}`;
          pageTitle.textContent=`SumOS RealTime Terminal! — ${v}`;
        }
      });

      baseRef.child('dataPrint').on('value',s=>{
        const v=s.val();
        if(v) appendRobot('[DATA] '+v);
      });
      baseRef.child('logs').on('child_added',s=>{
        const d=s.val();
        if(d&&d.text) appendRobot(d.text);
      });
      baseRef.child('command').on('value',s=>{
        const v=s.val();
        lastCmdEl.textContent=v??'-';
      });

      function sendCommand(){
        const txt=cmdInput.value.trim();
        if(!txt) return;
        if(txt.toLowerCase().startsWith('idrobot=')){
          const candidate=txt.split('=')[1]?.trim();
          if(!validateId(candidate)){appendRobot('[system] Invalid ID.');return;}
          appendRobot('[system] Setting Telegram ID to '+candidate);
          if(baseRef) baseRef.off();
          setConnectedId(candidate);
          cmdInput.value='';
          return;
        }
        baseRef.child('command').set(txt).then(()=>{
          baseRef.child('logs').push({text:'[you] '+txt,ts:Date.now()});
          appendYou('[you] '+txt);
          cmdInput.value='';
        }).catch(err=>appendRobot('[error] '+err.message));
      }

      // [FIX DOUBLE LISTENER] — pastikan event listener tak berganda
      sendBtn.replaceWith(sendBtn.cloneNode(true));
      cmdInput.replaceWith(cmdInput.cloneNode(true));
      sendBtn = document.getElementById('sendBtn');
      cmdInput = document.getElementById('cmdInput');

      // listener kekal sama, tapi tak double
      sendBtn.addEventListener('click',sendCommand);
      cmdInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendCommand();});
    }
  </script>
</body>
</html>
